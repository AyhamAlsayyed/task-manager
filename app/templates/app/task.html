{% extends "app/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/task.css' %}">
{% endblock %}

{% block content %}
<main>
    <section class="task-details">
        <h2>Task Details</h2>
        <p><strong>Title:</strong> {{ task.title }}</p>
        <p><strong>Description:</strong> {{ task.description|default:"No description" }}</p>
        <p><strong>Status:</strong> {{ task.get_status_display }}</p>
        <p><strong>Priority:</strong> {{ task.get_priority_display }}</p>
        <p><strong>Deadline:</strong> {{ task.deadline|date:"Y-m-d" }}</p>
        <p><strong>Assigned User:</strong> {{ task.user.username }}</p>
        <p><strong>Project:</strong> {{ task.project.title }}</p>

        <section class="edit-task" id="edit-task">
            <div id="edit-task-popup-form" class="popup-form">
                {% if error_message %}
                    <p class="error_message">{{ error_message }}</p>
                {% endif %}
                <form method="post" action="{% url 'app:edit_task' task.id %}">
                    {% csrf_token %}
                    <label for="title">Task Title:</label>
                    <input type="text" name="title" id="title" value="{{ request.POST.title|default:task.title }}" required>

                    <label for="description">Description:</label>
                    <input type="text" name="description" id="description" value="{{ request.POST.description|default:task.description }}">

                    <label for="status">Status:</label>
                    <select name="status" id="status">
                        <option value="todo" {% if task.status == "todo" %}selected{% endif %}>To Do</option>
                        <option value="inprogress" {% if task.status == "inprogress" %}selected{% endif %}>In Progress</option>
                        <option value="done" {% if task.status == "done" %}selected{% endif %}>Done</option>
                    </select>

                <label for="priority">Priority:</label>
                <select name="priority" id="priority">
                    <option value="0" {% if task.priority == 0 %}selected{% endif %}>Low</option>
                    <option value="1" {% if task.priority == 1 %}selected{% endif %}>Medium</option>
                    <option value="2" {% if task.priority == 2 %}selected{% endif %}>High</option>
                </select>

                <label for="deadline">Deadline:</label>
                <input type="date" name="deadline" id="deadline"
                       value="{{ request.POST.deadline|default:task.deadline|date:'Y-m-d' }}" required>

                <label for="user_id">Select User:</label>
                <select name="user_id" id="user_id" required>
                    {% for user in users_in %}
                        <option value="{{ user.id }}" {% if user.id == task.user.id %}selected{% endif %}>
                            {{ user.username }}
                        </option>
                    {% endfor %}
                </select>

                    <button type="submit">Save Changes</button>
                    <button type="button" id="cancelEditPopup">Cancel</button>
                </form>
            </div>
        </section>
        <button id="togglePopup">Edit Task</button>
    </section>
</main>

<script>
    {% if anchor %}
        window.location.hash = "{{ anchor }}";
    {% endif %}

    const togglebtn = document.getElementById("togglePopup");
    const edittaskpopupform = document.getElementById("edit-task-popup-form");
    const cancelBtn = document.getElementById("cancelEditPopup");

    {% if error_message %}
        edittaskpopupform.classList.add("show");
        togglebtn.classList.add("hide");
    {% endif %}

    togglebtn.addEventListener("click", () => {
        edittaskpopupform.classList.add("show");
        togglebtn.classList.add("hide");
    });

    cancelBtn.addEventListener("click", () => {
        edittaskpopupform.classList.remove("show");
        togglebtn.classList.remove("hide");
    });
</script>
{% endblock %}
